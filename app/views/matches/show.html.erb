<div class="container mx-auto px-4 py-8"
     data-controller="match-subscription"
     data-match-subscription-match-id-value="<%= @match.id %>">

  <!-- Header -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h1 class="text-3xl font-bold mb-2">
      Match #<%= @match.id %>
    </h1>
    <div class="text-gray-600">
      <%= @match.agent.name %> vs Stockfish Level <%= @match.stockfish_level %>
    </div>
    <div class="mt-2">
      <span class="px-3 py-1 rounded-full text-sm font-semibold
        <%= case @match.status
            when 'pending' then 'bg-yellow-100 text-yellow-800'
            when 'in_progress' then 'bg-blue-100 text-blue-800'
            when 'completed' then 'bg-green-100 text-green-800'
            when 'errored' then 'bg-red-100 text-red-800'
            end %>">
        <%= @match.status.titleize %>
      </span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Chess Board -->
    <div class="lg:col-span-2">
      <%= render MatchBoardComponent.new(match: @match) %>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Match Stats -->
      <%= render MatchStatsComponent.new(match: @match) %>

      <!-- Move List -->
      <%= render MoveListComponent.new(match: @match) %>
    </div>
  </div>

  <!-- Thinking Log (full width below) -->
  <% if @latest_agent_move %>
    <div class="mt-6">
      <%= render ThinkingLogComponent.new(move: @latest_agent_move) %>
    </div>
  <% end %>

  <!-- Move Input Form -->
  <% if @match.status_in_progress? %>
    <div class="bg-white rounded-lg shadow-md p-6 mt-4"
         data-controller="move-form"
         data-match-id="<%= @match.id %>">
      <h2 class="text-xl font-bold mb-4">Your Move</h2>

      <%= form_with url: "#", method: :post, data: { action: "submit->move-form#submit" } do |f| %>
        <div class="flex gap-2">
          <%= f.text_field :move_notation,
              placeholder: "e.g., e4, Nf3, O-O",
              class: "flex-1 px-3 py-2 border border-gray-300 rounded-md",
              data: { move_form_target: "input" } %>
          <%= f.submit "Submit Move",
              disabled: @match.moves.last&.player_agent?,
              class: "px-4 py-2 bg-blue-600 text-white rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed",
              data: { move_form_target: "submit" } %>
        </div>
      <% end %>

      <div data-move-form-target="error" class="mt-2 text-red-600 text-sm"></div>
      <div data-move-form-target="status" class="mt-2 text-gray-600 text-sm"></div>

      <% if @match.moves.last&.player_agent? %>
        <p class="mt-2 text-sm text-gray-500">Waiting for Stockfish...</p>
      <% end %>
    </div>
  <% elsif @match.status_completed? %>
    <div class="bg-white rounded-lg shadow-md p-6 mt-4">
      <h2 class="text-xl font-bold mb-2">Game Over</h2>
      <p class="text-lg">
        <% if @match.winner_draw? %>
          Draw by stalemate
        <% elsif @match.winner_agent? %>
          Human wins by checkmate!
        <% else %>
          Stockfish wins by checkmate
        <% end %>
      </p>
    </div>
  <% end %>
</div>
